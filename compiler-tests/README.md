# compiler-tests

New compiler tests using JetBrains' official compiler testing infrastructure. If possible, write new compiler tests in here! From [this PR](https://github.com/ZacSweers/metro/pull/128):

Essentially, you can have different kinds of categories of tests and then each test is just a `.kt` file. There are 3 categories here:

1. Diagnostic: create a `.kt` file somewhere under the `test/src/data/diagnostic` directory, rerun the `generateTests` Gradle task, and a new test will be generated for the file. When run, any diagnostics will be injected directly into the file as a sort of [golden value test](https://en.wikipedia.org/wiki/Characterization_test). Only the frontend of the compiler is executed, so these are extremely fast.

2. Dump: create a `.kt` file somewhere under the `test/src/data/dump/fir` or `test/src/data/dump/ir` directory, rerun the `generateTests` Gradle... (you get the idea). When run, the entire FIR tree for the `.kt` file will be dumped to a separate file `.fir.txt`. This is extremely helpful to figure out what exactly is being generated by a plugin. Only the frontend is executed for these tests as well.

3. Box: When run, the file will be compiled and the `box()` function will be executed, expecting `"OK"` as the output. You have access to `kotlin.test.assert*` functions to validate behavior. These tests will run the entire compiler, so helpful to test IR changes as well.

In all of these tests, the biggest way you will modify their behavior is through [directives](https://github.com/JetBrains/kotlin/tree/master/compiler/test-infrastructure#directives). You can create your own - I've done so with `GENERATE_ASSISTED_FACTORIES` to enable that plugin option - or you can use many of the [existing directives](https://github.com/JetBrains/kotlin/tree/master/compiler/tests-common-new/tests/org/jetbrains/kotlin/test/directives). They are specified as line comments and can be simple boolean flags like `RENDER_DIAGNOSTICS_FULL_TEXT` or be more complex like disabling to rendering of certain diagnostics with `DIAGNOSTICS: -PROVIDES_OR_BINDS_SHOULD_BE_PRIVATE`. In each of the base tests, you can also configure default directives that you want with `defaultDirectives`. For example, the dump tests are basically diagnostics tests but with the `FIR_DUMP` diagnostic always enabled.

Strongly recommend installing this plugin in IntelliJ: https://github.com/JetBrains/kotlin-compiler-devkit
